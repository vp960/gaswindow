<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
        * {
          box-sizing: border-box;
        }
        html{
            height: 100%;
        }
        body{
            height: 100%;
            background-color: #1e3f3f;
            margin: 0;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        input{
            font-weight: bold;
            border-radius: 15px;
        }
        input[readonly]{
            background-color: #ffffff5e;
        }
        
        .flexcontainer {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            flex-wrap: wrap;
        }
        .maincontainer{
            flex-flow: column; 
            padding: 5px;
            height:auto;
            min-height:100%;
            justify-content: center;
        }

        .main {
            display: flex;
            background-color: #f1f1f11a;
            padding: 5px;
            float: left;
            width: 100%;
            max-height: 95%;
            align-items: center;
            justify-content: space-evenly;
            margin: 5px;
            flex-wrap: wrap;
            position: relative
        }

        .line {
            flex-wrap: wrap;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            margin-top: 15px;
            margin-bottom: 15px;
            white-space: nowrap;
            align-items: center;
        }


        .cbutton{
            background-color: transparent;
            color: white;
            font-size: medium;
            font-weight: bold;
            padding: 5px;
            border: 2px solid lightslategrey;
            border-radius: 12px;
            cursor: pointer;
        }
        .pbutton{
            border-radius: 100%;
            width: 24px;
            height: 24px;
            line-height: 0.5;
            background-color: steelblue;
            color: black;
            font-weight: bold;
            font-size: large;
            text-align: center;
            margin: 1px;
        }

        .topbuttons{
            width: 100%;
            margin: 0; 
            margin-top: -10px;
            margin-right: -10px;
            position: absolute;
            top: 0;
        }

        .clicktab{
            font-size:large;
            flex-grow: 1;
            text-align: center;
            background-color: darkcyan;
        }
        .clicktab.selected{
            background-color: #1e3f3f;
        }
        .clicktab:hover{
            background-color: #1e3f3f;
        }
        .appendrow{
            line-height: 0.6;
        }
        .cellinput{
            min-width: 50px;
            max-width: 300px;
            white-space: normal;
            background-color: white;
            color: black;
            padding: 0 5px 0 5px;
            border-radius: 5px;
        }
        .cellinputtemplate{
            min-width: 50px;
            max-width: 300px;
            white-space: normal;
            background-color: white;
            color: black;
            padding: 0 5px 0 5px;
            border-radius: 5px;
        }
        .cellinputscript{
            min-width: 50px;
            max-width: 300px;
            white-space: normal;
            background-color: white;
            color: black;
            padding: 0 5px 0 5px;
            border-radius: 5px;
        }
        .addtask{
            background-color: #b56161d1;
        }
        .deleteobj{
            background-color: #b56161d1;
            color: white;
        }
        .adddocument{
            background-color: #66b561d1;
        }
        .hiddenfields{
            background-color: transparent;
            border: none;
            cursor: pointer;
        }
        .hiddenfieldsdiv{
            display:flex;
            justify-content:center;
            align-items: center;
            background-color:transparent;
        }

        .loader {
            transform: rotateZ(45deg);
            perspective: 1000px;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            color: #fff;
        }
        .loader:before,
        .loader:after {
            content: '';
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: inherit;
            height: inherit;
            border-radius: 50%;
            transform: rotateX(70deg);
            animation: 1s spin linear infinite;
        }
        .loader:after {
            color: #FF3D00;
            transform: rotateY(70deg);
            animation-delay: .4s;
        }
        .modal-background{
            display: none;
            background-color: #0000005c;
            position: fixed;
            width: 100%;
            height: 100%;
            top:0;
            bottom:0;
            left:0;
            right:0;
            z-index: 10;
        }
        .modal{
            display: none;
            position: fixed;
            background-color: #53576b;
            width: 90%;
            height: 80%;
            top: 10%;
            left: 5%;
            z-index: 11;
            overflow-y: auto;
        }
        #loader{
            display:none; position: fixed;top: 10px;right: 58px;
        }
        .main2{
            display: flex;
            background-color: #f1f1f11a;
            float: left;
            width: 100%;
            max-height: 95%;
            align-items: center;
            justify-content: space-evenly;
            margin: 0;
            padding: 0;
            flex-wrap: wrap;
        }
        .line2{
            flex-grow: 1;
            display: flex;
            justify-content: center;
            margin: 0;
            padding: 0;
            white-space: nowrap;
            align-items: center;
        }
        .w100{
            width: 100%;
        }
        .w50{
            width: 50%;
        }
        .h100{
            height: 100%;
        }
        .h50{
            height: 50%;
        }
        .h100min{
            height: calc(100% - 1.5em);
        }
        .h50min{
            height: calc(50% - 0.75em);
        }
        .hi{
            height: inherit;
        }
        h1{
            margin: 0;
            font-size: 1.5em;
        }


        .scdiv{
            width:100%;
            height: 100%;
            z-index:12;
            position: absolute;
            display: none;
        }
        #displaysc{
            width: 100%;
            height: 100%;
            object-position: 0;
            object-fit: fill;
        }
        #closesc{
            position: fixed;
            z-index: 14;
            top: 10px;
            left: 10px;
            background-color: red;
            padding: 5;
            line-height: 0.7;
        }
      @keyframes rotate {
        0% {transform: translate(-50%, -50%) rotateZ(0deg);}
        100% {transform: translate(-50%, -50%) rotateZ(360deg);}
      }

      @keyframes rotateccw {
        0% {transform: translate(-50%, -50%) rotate(0deg);}
        100% {transform: translate(-50%, -50%) rotate(-360deg);}
      }

      @keyframes spin {
        0%,
        100% {box-shadow: .2em 0px 0 0px currentcolor;}
        12% {box-shadow: .2em .2em 0 0 currentcolor;}
        25% {box-shadow: 0 .2em 0 0px currentcolor;}
        37% {box-shadow: -.2em .2em 0 0 currentcolor;}
        50% {box-shadow: -.2em 0 0 0 currentcolor;}
        62% {box-shadow: -.2em -.2em 0 0 currentcolor;}
        75% {box-shadow: 0px -.2em 0 0 currentcolor;}
        87% {box-shadow: .2em -.2em 0 0 currentcolor;}
      }
        /* Use a media query to add a break point at 800px: */
        @media screen and (max-width: 800px) {
             .main {
                width: 100%; /* The width is 100%, when the viewport is 800px or smaller */
            }
            .maincontainer{
                height: auto;
            }
            .clicktab{
                flex: 1 33%;
            }
            .w50{
                width: 100%;
            }
        }
        </style>
    </head>
    <body>
        <div id="loader"><span class="loader"></span></div>
        <div class="modal-background"></div>
        <div class="scdiv"/>
            <img id="displaysc" />
            <button class="cbutton" id="closesc">X</button>
        </div>
        <div id="modaltemplate" class="modal flexcontainer">
            <div class="main2">
                <h1 style="margin: 0;">Templating Engine</h1>
                <select id="templateSelect" style="min-width: 300px"></select>
                <button id="plustemplatebutton" class="cbutton">+template</button>
            </div>
            <div class="main2 hi w50" id="staticdiv">
                <h1 style="margin: 0;">Champs Statiques</h1>
                <div id="staticfields" class="main2 w100 h50min"></div>
                <textarea id="staticmapper"  class="w100 h50min"></textarea>
            </div>
            <div class="main2 hi w50" id="dynamicdiv">
                <h1 style="margin: 0;">Champs Dynamique</h1>
                <div class="line2 h100min w100">
                    <div class="flexcontainer h100 w50">
                        <textarea id="dynamicmapper" class="h50 w100"></textarea>
                        <textarea id="dynamicfilter" class="h50 w100"></textarea>
                    </div>
                    <textarea id="dynamicdatadisplay" class="h100 w50" style="border: 3px solid cornflowerblue;" readonly></textarea>
                </div>
            </div>
            <div class="main2">
                <button id="sendTemplateConfig" class="cbutton">Generer Doc</button>
            </div>
        </div>
        <div id="modalscripting" class="modal flexcontainer">
            <div class="main2">
                <button id="displayscbutton" class="cbutton">Afficher Browser</button>
                <button id="displayscriptqueue" class="cbutton">File d'execution &nbsp; <b id="scriptleftinqueue"></b></button>
                <h1 style="margin: 0;">Scripting Engine</h1>
                <select id="scriptSelect" style="min-width: 300px"></select>
                <button id="plusscriptbutton" class="cbutton">+script</button>
            </div>
            <div class="main2 hi w50">
                <h1 style="margin: 0;">Champs Statiques</h1>
                <div id="scriptfields" class="main2 w100 h50min"></div>
                <textarea id="scriptmapper"  class="w100 h50min"></textarea>
            </div>
            <div class="main2 hi w50">
                <h1 style="margin: 0;">Script</h1>
                <textarea id="scripttemplate" class="w100 h100min" style="border: 3px solid cornflowerblue;"></textarea>
            </div>
            <div class="main2">
                <button id="executeScriptConfig" class="cbutton">Ajouter a la file</button>
            </div>
        </div>
        <div id="modaldisplay" class="modal flexcontainer">
            <button class="cbutton" style="float: right;" id="closemd">X</button>
            <div id="contentmd"></div>
        </div>
        <div class="flexcontainer maincontainer">
            <h1 style="text-align: center;margin-top: 50px;">CRM de DING</h1>
            <div class="main" id="screen1">
                <label>Profile: </label>
                <input type="text" id="profile_id" />
                <div>Search: <input type="text" placeholder="Filter..." id="filtersearch"/></div>
                <button id="scriptingbutton" class="cbutton">Scripting</button>
            </div>
            <div class="flexcontainer" id="screen2"></div>
        </div>
        <script>
            var PrintPlugin = (function (win, doc) {
                function getPrintableHTMLContent(str) {
                    var htmlEl = doc.implementation.createHTMLDocument("Printable Document");
                    htmlEl.body.innerHTML = str;
                    return htmlEl.documentElement.outerHTML;
                }
                
                function printHTML(str) {
                var contentType = 'text/html;charset=utf-8'
                    var fullHTMLStr = getPrintableHTMLContent(str);
                    var contentBlob = new Blob([str], {type : contentType});
                    
                    var frameEl = doc.createElement('iframe'),
                        removeFrame = function () {
                            if (frameEl) {
                                doc.body.removeChild(frameEl);
                                frameEl = null;
                            }
                        };
                    frameEl.style.display = "none";
                    frameEl.onload = function () {
                        try {
                            this.contentWindow.print();
                            setTimeout(function () {
                                // Timeout is used due to Firefox bug, when <iframe> is being removed before print occurs
                                removeFrame();
                            }, 0);
                        } catch (e) {
                            console.log(e);
                        }
                    };
                    
                    frameEl.src = URL.createObjectURL(contentBlob);
                    doc.body.appendChild(frameEl);
                    
                    return frameEl.contentWindow;
                }
                
                return {
                    print: printHTML
                }
            })(window, document);
            const { fetch: originalFetch } = window;

            window.fetch = async (...args) => {
                let [resource, config ] = args;
                loader.style.display = 'block';
                const response = await originalFetch(resource, config);
                loader.style.display = 'none';
                return response;
            };
        </script>
        <script src="./pptrweb.js"></script>
        <script>
            var id_script = window.location.href.split('/s/')[1]?.split('/exec')[0] ||'AKfycbzgOlNjUW5h21cdZjL6U4au-n9URhcbIF0w83G4hOf4R9kz7RuGaFFjd1BVioXClpcgpg';


            document.querySelector('.modal-background').addEventListener('click', closeModal);
            var csl = console.log;
            var jss = JSON.stringify;
            var jsp = JSON.parse;
            var sleep = async function(seconds){ return new Promise(resolve=>setTimeout(resolve,seconds*1000)); }
            const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
            var templates = [];
            var scripts = [];
            var currentTemplate = null;
            var currentScript = null;
            var currentDocument = null;
            var currentPage = null;
            var currentSession = null;
            var currentDisplay = [];// used to reproduce which div main is display flex for currentLocation after rebuildExplorer
            var datalibre = [];
            var datalibre_subset = [];
            var profile = null;
            var id_dict = {};
            var data = {
                companies: [],
                accounts: [],
                pservices: [],
                aservices: [],
                documents: [],
                tasks: [],
            }
            var headers = {
                profile: [],
                company: [],
                account: [],
                pservice: [],
                aservice: [],
                document: [],
                task: [],
            };
            var pluralMapper = {
                profiles: 'profile',
                companies: 'company',
                accounts: 'account',
                pservices: 'pservice',
                aservices: 'aservice',
                documents: 'document',
                tasks: 'task',
            }
            var singularMapper = Object.entries(pluralMapper).reduce((acc,e)=>({[e[1]]:e[0], ...acc}),{});
            var BGMapper = {
                task: "background-color: #b561613d;",
                document: 'background-color: #66b5613d;',
                account: 'background-color: #b78bdf3d;',
                company: 'background-color: #7788993d;',
                pservice: 'background-color: #ffa85b3d;',
                aservice: 'background-color: #5ddfb63d;',
            };
            var templatingDefaultConfig = {
                staticfields: {'{{customer_name}}': '', '{{customer_firstname}}': ''},
                staticmapper: `{{customer_name}}: profile.Nom
                                {{customer_firstname}}: profile.Prenom`.replaceAll('    ', ''),
                dynamicfilter: `Type === Depense: 4`,
                dynamicmapper: `{{item_description}}: value1
                            {{item_price}}: value2
                            {{item_date}}: value3`.replaceAll('    ', ''),
            };
            var scriptingDefaultConfig = {
                scriptfields: {'url': ''},
                scriptmapper: ``,
                scripttemplate: `page.goto(settings.staticfields.url)`,
            };
            var scriptQueue = [];
            var url_script = 'https://script.google.com/macros/s/'+id_script+'/exec';
            document.querySelector('.modal-background').addEventListener('click', closeModal);


            profile_id.addEventListener('change', async function(e){
                if(!profile_id.value.length) return;
                // profile = JSON.parse('{"Line":1,"Pictures and videos":"","Telephone":"0730302930","Pays":"FRAAAANCE","Zip":75019,"Commune":"Paris","Adresse":"30 rue Chapon","Lieu de Naissance":"Paris","Date de Naissance":"13/12/1992","Prenom":"JEAN","Nom":"PAUL","Pass Email":"C123s","Email":"jeanpaul4@gmail.com","ID":"jeanpaul4@gmail.com","companies":[["Reference","ID","Siren","Nom","KBIS","Nom Gerant","Prenom Gerant","Adresse","Commune","Zip","services publiques","autres services","Line"],{"Line":1,"autres services":"","services publiques":"","Zip":75019,"Commune":"Paris","Adresse":"30 rue chapon","Prenom Gerant":"","Nom Gerant":"","KBIS":"","Nom":"JPServices","Siren":12345,"ID":"company-12345","Reference":"jeanpaul4@gmail.com","companies":[],"documents":[],"tasks":[{"Line":2,"Responsabilite":"jp","Statut":"TODO","Description":"Generer Releve","ID":"task-2","Reference":"company-12345","tasks":[]}],"accounts":[{"tasks":[],"Line":2," ":"","login url":"","data":"","password":"C1234s","login":"jpservices4@gmail.com","Nom banque":"BNP","IBAN":"FR75xxx2","ID":"account-FR75xxx2","Reference":"company-12345"}],"pservices":[{"tasks":[],"Line":3,"Documents":"","login_url":"","data":"","pass":"c123s","login":"jpservices4@gmail.com","Nom":"guichet unique","ID":"pservice-3","Reference":"company-12345"}],"aservices":[]},{"Line":2,"autres services":"","services publiques":"","Zip":75019,"Commune":"Paris","Adresse":"2 rue chapon","Prenom Gerant":"","Nom Gerant":"","KBIS":"","Nom":"JPGros","Siren":54321,"ID":"company-54321","Reference":"jeanpaul4@gmail.com","companies":[],"documents":[{"tasks":[],"Line":2,"Description":"KBIS","Lien":"","ID":"document-2","Reference":"company-54321"}],"tasks":[{"Line":3,"Responsabilite":"jp","Statut":"TODO","Description":"Generer Releve","ID":"task-3","Reference":"company-54321","tasks":[]}],"accounts":[{"tasks":[],"Line":4," ":"","login url":"","data":"","password":"c12s","login":"jpgros4@gmail.com","Nom banque":"CIC","IBAN":"FR75xxx4","ID":"account-FR75xxx4","Reference":"company-54321"}],"pservices":[],"aservices":[]}],"documents":[["Reference","ID","Lien","Description","Line"],{"tasks":[],"Line":1,"Description":"Facture Orange","Lien":"","ID":"document-1","Reference":"jeanpaul4@gmail.com"},{"tasks":[],"Line":3,"Description":"Avis d impots","Lien":"","ID":"document-3","Reference":"jeanpaul4@gmail.com"}],"tasks":[["Reference","ID","Description","Statut","Responsabilite","Line"],{"Line":1,"Responsabilite":"jp","Statut":"TODO","Description":"Generer Releve","ID":"task-1","Reference":"jeanpaul4@gmail.com","tasks":[]}],"accounts":[["Reference","ID","IBAN","Nom banque","login","password","data","login url"," ","Line"],{"tasks":[],"Line":1," ":"","login url":"","data":"","password":"C123s","login":"jeanpaul4@gmail.com","Nom banque":"SG","IBAN":"FR75xxx1","ID":"account-FR75xxx1","Reference":"jeanpaul4@gmail.com"},{"tasks":[],"Line":3," ":"","login url":"","data":"","password":"C1234s","login":"jeanpaul4@gmail.com","Nom banque":"CIC","IBAN":"FR75xxx3","ID":"account-FR75xxx3","Reference":"jeanpaul4@gmail.com"}],"pservices":[["Reference","ID","Nom","login","pass","data","login_url","Documents","Line"],{"tasks":[],"Line":1,"Documents":"","login_url":"","data":"","pass":"c123s","login":12345678901213,"Nom":"impots","ID":"pservice-1","Reference":"jeanpaul4@gmail.com"},{"tasks":[],"Line":2,"Documents":"","login_url":"","data":"","pass":"c124","login":"jeanpaul4@gmail.com","Nom":"ameli","ID":"pservice-2","Reference":"jeanpaul4@gmail.com"}],"aservices":[["Reference","ID","Nom","login","pass","data","login_url","Documents","Line"],{"tasks":[],"Line":1,"Documents":"","login_url":"","data":"","pass":"c123s","login":"jeanpaul4@gmail.com","Nom":"instagram","ID":"aservice-1","Reference":"jeanpaul4@gmail.com"},{"tasks":[{"Line":4,"Responsabilite":"","Statut":"","Description":"","ID":"task-jkkjlgbggjif","Reference":"aservice-2","tasks":[]}],"Line":2,"Documents":"","login_url":"","data":"","pass":"c123s","login":"jeanpaul4@proton.me","Nom":"protonmail","ID":"aservice-2","Reference":"jeanpaul4@gmail.com"},{"tasks":[],"Line":3,"Documents":"","login_url":"","data":"","pass":"c123s","login":"jeanpaul4@proton.me","Nom":"Facebook","ID":"aservice-3","Reference":"jeanpaul4@gmail.com"}],"headers":["ID","Email","Pass Email","Nom","Prenom","Date de Naissance","Lieu de Naissance","Adresse","Commune","Zip","Pays","Telephone","Pictures and videos","Line"]}');
                profile = await fetch(`${url_script}?profile=${encodeURIComponent(profile_id.value)}`,{redirect:'follow'}).then(res=>res.json());
                headers.profile = profile.headers;
                delete profile.headers;
                Object.entries(profile).forEach(e=>{
                    if(typeof e[1] === 'object'){
                        headers[pluralMapper[e[0]]] = e[1][0];
                        profile[e[0]] = e[1].slice(1);
                    }
                })
                buildExplorer();
                addTemplatingListeners();
            });
            
            addScriptingListeners();


            function addScriptingListeners(){
                document.querySelector('#scriptingbutton').addEventListener('click', async (e)=>{
                    getPage();
                    if(scripts.length === 0){
                        ({scripts} = await fetch(`${url_script}?getScripts=true`,{redirect:'follow'}).then(res=>res.json()))
                        var headerss = scripts[0];
                        scripts = scripts.slice(1).map((t,i)=>{
                            t = toObj(t, headerss)
                            scriptSelect.innerHTML += `<option value="${t.Description}" ${i === 0? 'selected' : ''}>${t.Description}</option>`;
                            try{ 
                                t.Config = JSON.parse(t.Config);
                            }
                            catch(err){
                                console.error(err);
                                t.Config = scriptingDefaultConfig;
                            }
                            return t;
                        });
                        scriptSelect.value = scripts[0].Description;
                        currentScript = scripts[0];
                        loadScript();
                    }
                    openModalScript();
                });
                executeScriptConfig.addEventListener('click', async (e)=>{
                    var func = AsyncFunction('page', 'settings', scripttemplate.value);
                    scriptQueue.push([func, jsp(jss(currentScript.Config.scriptfields)), currentScript.Description]);
                    launchScriptQueue();
                });
                displayscbutton.addEventListener('click', async (e)=>{
                    displayBrowserScreen();
                });
                closesc.addEventListener('click', async (e)=>{
                    closeBrowserScreen();
                });
                scriptSelect.addEventListener('change',(e)=>{
                    currentScript = scripts.find(t=>t.Description === scriptSelect.value);
                    loadScript();
                })
                scriptmapper.addEventListener('change',(e)=>{
                    currentScript.Config.scriptmapper = e.target.value;
                    saveScriptConfig();
                    loadScript();
                })
                scripttemplate.addEventListener('change',(e)=>{
                    currentScript.Config.scripttemplate = e.target.value;
                    saveScriptConfig();
                    loadScript();
                })
                plusscriptbutton.addEventListener('click', async (e)=>{
                    var description = prompt('New Script Name:', 'newscript');
                    scripts.push({
                        Description: description,
                        Type: 'simple',
                        Config: scriptingDefaultConfig
                    });
                    currentScript = scripts[scripts.length - 1];
                    scriptSelect.innerHTML += `<option value="${description}">${description}</option>`;
                    loadScript();
                    const qs = new URLSearchParams({operation: 'appendrow', table: 'scripts'});
                    var res = await fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify([description])}).then(res=>res.json());
                })
                displayscriptqueue.addEventListener('click', async (e)=>{
                    contentmd.innerHTML = scriptQueue.map((s)=>`<div><b>${s[2]} :</b><a>${jss(s[1], null, 2)}</a></div>`).join('');
                    scriptleftinqueue.innerHTML = `(${scriptQueue.length})`;
                    modaldisplay.style.display = 'block';
                })
            }
            async function launchScriptQueue(){
                while(scriptQueue.length > 0){
                    var script = scriptQueue.shift();
                    try{
                        await script[0](currentPage, script[1]);
                        contentmd.innerHTML = contentmd.innerHTML.replace(`<div><b>${script[2]} :</b><a>${jss(script[1], null, 2)}</a></div>`, '');
                        console.log('done2')
                    }catch(err){
                        console.warn(err);
                    }
                    scriptleftinqueue.innerHTML = `(${scriptQueue.length})`;
                }
            }
            function loadScript(){
                scripttemplate.value = currentScript.Config.scripttemplate;
                scriptmapper.value = currentScript.Config.scriptmapper;
                var mapper = staticmapper.value.split('\n').reduce((acc, line)=>{
                    line = line.split(':');
                    if(!line[1]) return acc;
                    if(line[2]) acc[line[0].trim()] = {newText: line[1].trim(), ...line[2].split(',').reduce((acc,option)=>({...acc, [option.trim()]: true}),{})}
                    else acc[line[0].trim()] = {newText: line[1].trim()};
                    return acc;
                },{});
                scriptfields.innerHTML = '';
                Object.keys(currentScript.Config.scriptfields).forEach(f=>{
                    var value;
                    if(mapper[f]?.newText && mapper[f]?.newText.length){
                        value = mapper[f].newText.split('+').map(p=>{
                            return (resolveEntityValue(p.trim().split('.')) || currentScript.Config.scriptfields[f]);
                        }).join(' ');
                    }
                    value = value || currentScript.Config.scriptfields[f];
                    currentScript.Config.scriptfields[f] = value;
                    scriptfields.innerHTML += `<div class="line"><label>${f}</label>&nbsp;&nbsp;&nbsp;&nbsp;<span class="cellinputscript" data-field="${f}" contenteditable>${value}</span>&nbsp;&nbsp;&nbsp;&nbsp;<button class="deletefieldscript cbutton" data-field="${f}">-</button></div>`
                })
                setTimeout(()=>{
                    Array.from(document.querySelectorAll('.cellinputscript')).forEach(el=>el.addEventListener('blur',cellinputscriptEL));
                    Array.from(document.querySelectorAll('.deletefieldscript')).forEach(el=>el.addEventListener('click',deletefieldscriptEL))
                },500)


                scriptfields.innerHTML += `<div class="line"><button class="cbutton plusfieldscript">+field</button></div>`;
                document.querySelector('.plusfieldscript').addEventListener('click',plusfieldscriptEL)
            }
            function saveScriptConfig(){
                const qs = new URLSearchParams({operation: 'updaterange', table: 'scripts'});
                return fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify({row: scripts.indexOf(currentScript)+1, col: 2, val: JSON.stringify(currentScript.Config)})}); 

            }
            function cellinputscriptEL(e){
                currentScript.Config.scriptfields[e.target.dataset.field] = e.target.innerHTML;
                saveScriptConfig();
            }
            function deletefieldscriptEL(e){
                delete currentScript.Config.scriptfields[e.target.dataset.field];
                scriptmapper.value = currentScript.Config.scriptmapper = currentScript.Config.scriptmapper.split('\n').filter(s=>s.trim().indexOf(e.target.dataset.field)!==0).join('\n');
                e.target.parentNode.remove();
                saveScriptConfig();
            }
            function plusfieldscriptEL(e){
                var field = prompt("Field Name");
                currentScript.Config.scriptfields[field] = '';
                e.target.parentNode.insertAdjacentHTML('beforebegin', `<div class="line"><label>${field}</label>&nbsp;&nbsp;&nbsp;&nbsp;<span class="cellinputscript" data-field="${field}" contenteditable></span>&nbsp;&nbsp;&nbsp;<button class="deletefieldscript cbutton" data-field="${field}">-</button></div>`);
                document.querySelector(`.cellinputscript[data-field="${field}"]`).addEventListener('blur', cellinputscriptEL);
                document.querySelector(`.deletefieldscript[data-field="${field}"]`).addEventListener('click', deletefieldscriptEL);
            }


            async function getPage(){
                loader.style.display = 'block';
                const browser = await puppeteer.connect({
                    browserWSEndpoint: `ws://127.0.0.1:9090`,
                    ignoreHTTPSErrors: true,
                });
                const browserWSEndpoint = await browser.wsEndpoint();
                var open_pages = await browser.pages();
                var page = currentPage = open_pages[0];
                page.setDefaultTimeout(0);
                await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36');
                await page.evaluateOnNewDocument(() => { 
                    Object.defineProperty(navigator, 'webdriver', {get: () => false,});
                    Object.defineProperty(navigator, 'plugins', {get: () => [1, 2, 3, 4, 5], });
                    Object.defineProperty(navigator, 'languages', {get: () => ['fr-FR', 'fr']});
                    const originalQuery = window.navigator.permissions.query;
                    return window.navigator.permissions.query = (parameters) => (parameters.name === 'notifications' ? Promise.resolve({ state: Notification.permission }) : originalQuery(parameters) );
                });
                await page.setBypassCSP(true);

                await page.setViewport({width: window.innerWidth, height: window.innerHeight});
                await page.goto('https://www.github.com/');
                console.log({ browserWSEndpoint });

                loader.style.display = 'none';
                return page;
            }
            async function displayBrowserScreen(){
                if(!currentPage) return alert('no page loaded');

                loader.style.display = 'block';
                const context = await currentPage.target();
                currentSession = await context.createCDPSession();

                csl(currentSession);
                currentSession.on('Page.screencastFrame', async ({ metadata, data, sessionId }) => {
                    if (!metadata.timestamp ) return console.log('no timestamp');
                    displaysc.src = "data:image/jpeg;base64,"+data;
                    try {
                        await currentSession.send('Page.screencastFrameAck', {sessionId});
                    }
                    catch (error) {
                        console.error('Error in sending Acknowledgment for PageScreenCast', error.message);
                    }
                });

                try {
                    displaysc.parentElement.style.display = 'block';
                    await currentSession.send('Animation.setPlaybackRate', { playbackRate: 1, });
                    await currentSession.send('Page.startScreencast', { everyNthFrame: 1, format: 'jpeg', quality: 100, });
                    displaysc.addEventListener('click',mouseDispatcher)
                    displaysc.addEventListener('mousemove',mouseDispatcher)
                    document.addEventListener('keydown',keyboardDispatcher.down)
                    document.addEventListener('keyup',keyboardDispatcher.up)
                    displaysc.addEventListener('wheel',wheelDispatcher)
                }
                catch (e) {
                    console.error(e);
                }

                loader.style.display = 'none';
            }
            async function closeBrowserScreen(){
                await currentSession.send('Page.stopScreencast');
                displaysc.parentElement.style.display = 'none';
                displaysc.removeEventListener('click',mouseDispatcher)
                displaysc.removeEventListener('mousemove',mouseDispatcher)
                document.removeEventListener('keydown',keyboardDispatcher.down)
                document.removeEventListener('keyup',keyboardDispatcher.up)
                displaysc.removeEventListener('wheel',wheelDispatcher)
            }
            function mouseDispatcher(e){
                currentPage.mouse.click(e.offsetX, e.offsetY);
            }
            var keyboardDispatcher = {
                up: function (e){
                    if(displaysc.parentElement.style === 'none') return;
                    currentPage.keyboard.up(e.code);
                },
                down: function (e){
                    if(displaysc.parentElement.style === 'none') return;
                    currentPage.keyboard.down(e.code);
                },
            };
            function wheelDispatcher(e){
                currentPage.mouse.wheel(e.deltaX, e.deltaY);
            }


            function addTemplatingListeners(){
                filtersearch.addEventListener('keyup',filterEL);

                templateSelect.addEventListener('change', (e)=>{
                    currentTemplate = templates.find(t=>t.Description === templateSelect.value);
                    loadTemplate();
                })
                staticmapper.addEventListener('change',(e)=>{
                    currentTemplate.Config.staticmapper = e.target.value;
                    saveTemplateConfig();
                    loadTemplate();
                })
                dynamicmapper.addEventListener('change',(e)=>{
                    currentTemplate.Config.dynamicmapper = e.target.value;
                    saveTemplateConfig();
                    loadDLSubset()
                })
                dynamicfilter.addEventListener('change',(e)=>{
                    var template = templates.filter(t=>t.Description === templateSelect.value);
                    currentTemplate.Config.dynamicfilter = e.target.value;
                    saveTemplateConfig();
                    loadDLSubset();
                })
                sendTemplateConfig.addEventListener('click',async (e)=>{
                    if(currentTemplate.Type === 'DOC'){
                        var tablefields = JSON.parse(dynamicdatadisplay.value);
                        var qs = new URLSearchParams({operation: 'templatedoc'});
                        var res = await fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify({
                            docID: currentDocument.ID, 
                            staticfields: currentTemplate.Config.staticfields, 
                            tablefields,
                            docurl:currentTemplate.Lien,
                        })}).then(res=>res.json());
                        console.log(res);
                        currentDocument.Lien = res.fileURL;
                        buildExplorer();
                        closeModal();
                        qs = new URLSearchParams({operation: 'updaterange', table: 'documents'});
                        fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify({row: currentDocument.Line, col: headers[pluralMapper['documents']].indexOf('Lien'), val: currentDocument.Lien})});
                    }
                    else if(currentTemplate.Type === 'PDF'){
                        var mapper = staticmapper.value.split('\n').reduce((acc, line)=>{
                            line = line.split(':');
                            if(!line[1]) return acc;
                            if(line[2]) acc[line[0].trim()] = {newText: line[1].trim(), ...line[2].split(',').reduce((acc,option)=>({...acc, [option.trim()]: true}),{})}
                            else acc[line[0].trim()] = {newText: line[1].trim()};
                            return acc;
                        },{});
                        openPDF(currentTemplate.Lien, Object.entries(currentTemplate.Config.staticfields).reduce((acc,e)=>({...acc, [e[0]]: {...mapper[e[0]], newText: e[1]}}), {}));
                    }
                })
                
                plustemplatebutton.addEventListener('click',async (e)=>{
                    var description = prompt('New Template Name:', 'newtemplate');
                    var type = prompt('New Template Type (DOC ou PDF):', 'PDF');
                    var lien = prompt('New Script Link:');
                    templates.push({
                        Description: description,
                        Type: type,
                        Lien: lien,
                        Config: scriptingDefaultConfig
                    });
                    currentTemplate = templates[templates.length - 1];
                    loadTemplate();
                    const qs = new URLSearchParams({operation: 'appendrow', table: 'templates'});
                    var res = await fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify([description, type, lien])}).then(res=>res.json());
                })
            }
            async function templatingEL(e){
                if(templates.length === 0){
                    ({templates, datalibre} = await fetch(`${url_script}?getTemplates=true`,{redirect:'follow'}).then(res=>res.json()))
                    var headerst = templates[0];
                    templates = templates.slice(1).map((t,i)=>{
                        t = toObj(t, headerst)
                        templateSelect.innerHTML += `<option value="${t.Description}" ${i === 0? 'selected' : ''}>${t.Description}</option>`;
                        try{ 
                            t.Config = JSON.parse(t.Config);
                        }
                        catch(err){
                            console.error(err);
                            t.Config = templatingDefaultConfig;
                        }
                        return t;
                    });
                    templateSelect.value = templates[0].Description;
                    currentTemplate = templates[0];
                    currentDocument = id_dict[e.target.dataset.document];

                    var headersdl = datalibre[0];
                    datalibre = datalibre.slice(1).map(t=>toObj(t, headersdl));
                    loadTemplate();
                }
                openModalTemplate();
            }
            function saveTemplateConfig(){
                const qs = new URLSearchParams({operation: 'updaterange', table: 'templates'});
                return fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify({row: templates.indexOf(currentTemplate)+1, col: 3, val: JSON.stringify(currentTemplate.Config)})}); 
            }
            async function loadTemplate(){
                staticmapper.value = currentTemplate.Config.staticmapper;
                var mapper = staticmapper.value.split('\n').reduce((acc, line)=>{
                    line = line.split(':');
                    if(!line[1]) return acc;
                    if(line[2]) acc[line[0].trim()] = {newText: line[1].trim(), ...line[2].split(',').reduce((acc,option)=>({...acc, [option.trim()]: true}),{})}
                    else acc[line[0].trim()] = {newText: line[1].trim()};
                    return acc;
                },{});
                staticfields.innerHTML = '';
                Object.keys(currentTemplate.Config.staticfields).forEach(f=>{
                    var value;
                    if(mapper[f]?.newText && mapper[f]?.newText.length){
                        value = mapper[f].newText.split('+').map(p=>{
                            return (resolveEntityValue(p.trim().split('.')) || currentTemplate.Config.staticfields[f]);
                        }).join(' ');
                    }
                    value = value || currentTemplate.Config.staticfields[f];
                    currentTemplate.Config.staticfields[f] = value;
                    staticfields.innerHTML += `<div class="line"><label>${f}</label>&nbsp;&nbsp;&nbsp;&nbsp;<span class="cellinputtemplate" data-field="${f}" contenteditable>${value}</span>&nbsp;&nbsp;&nbsp;&nbsp;<button class="deletefieldtemplate cbutton" data-field="${f}">-</button></div>`
                })
                setTimeout(()=>{
                    Array.from(document.querySelectorAll('.cellinputtemplate')).forEach(el=>el.addEventListener('blur',cellinputtemplateEL));
                    Array.from(document.querySelectorAll('.deletefieldtemplate')).forEach(el=>el.addEventListener('click',deletefieldtemplateEL))
                },500)


                staticfields.innerHTML += `<div class="line"><button class="cbutton plusfieldtemplate">+field</button></div>`;
                document.querySelector('.plusfieldtemplate').addEventListener('click',plusfieldtemplateEL)
                    
                if(currentTemplate.Type === 'DOC'){
                    dynamicdiv.style.display = 'flex';
                    dynamicmapper.value = currentTemplate.Config.dynamicmapper;
                    dynamicfilter.value = currentTemplate.Config.dynamicfilter;
                    loadDLSubset();
                }
                else if(currentTemplate.Type === 'PDF'){
                    dynamicdiv.style.display = 'none';
                }
            }
            function cellinputtemplateEL(e){
                currentTemplate.Config.staticfields[e.target.dataset.field] = e.target.innerHTML;
                saveTemplateConfig();
            }
            function deletefieldtemplateEL(e){
                delete currentTemplate.Config.staticfields[e.target.dataset.field];
                staticmapper.value = currentTemplate.Config.staticmapper = currentTemplate.Config.staticmapper.split('\n').filter(s=>s.trim().indexOf(e.target.dataset.field)!==0).join('\n');
                e.target.parentNode.remove();
                saveTemplateConfig();
            }
            function plusfieldtemplateEL(e){
                var field = prompt("Field Name");
                currentTemplate.Config.staticfields[field] = '';
                e.target.parentNode.insertAdjacentHTML('beforebegin', `<div class="line"><label>${field}</label>&nbsp;&nbsp;&nbsp;&nbsp;<span class="cellinputtemplate" data-field="${field}" contenteditable></span>&nbsp;&nbsp;&nbsp;<button class="deletefieldtemplate cbutton" data-field="${f}">-</button></div>`);
                document.querySelector(`.cellinputtemplate[data-field="${field}"]`).addEventListener('blur', cellinputtemplateEL);
                document.querySelector(`.deletefieldtemplate[data-field="${field}"]`).addEventListener('click', deletefieldtemplateEL);
            }
            function loadDLSubset(){
                var mapper = dynamicmapper.value.split('\n').reduce((acc, line)=>{
                    line = line.split(':');
                    if(!line[1]) return acc;
                    acc[line[0].trim()] = line[1].trim();
                    return acc;
                },{});
                var filters = dynamicfilter.value.split('\n').reduce((acc, line)=>{
                    line = line.split(':');
                    if(!line[1]) return acc;
                    var number = line[1].trim();
                    var [field, value] = line[0].split('===').map(s=>s.trim());
                    acc[field] = acc[field] || {};
                    acc[field][value] = number;
                    return acc;
                },{});
                var subset = Object.keys(filters).length ? datalibre.filter(row=>{
                    var include = false;
                    Object.entries(row).forEach(e=>{
                        if(filters[e[0]] && filters[e[0]][e[1]]){
                            include = true;
                            filters[e[0]][e[1]]--; //pour data non chevauchantes break loop here
                        }
                    });
                    return include;
                }) : datalibre;

                subset = subset.map(row=>{
                    return Object.entries(mapper).reduce((acc,e)=>{
                        acc[e[0]] = row[e[1]];
                        return acc;
                    },{})
                })

                dynamicdatadisplay.value = JSON.stringify(subset, null, 2);
            }
            function openPDF(fileurl, settings) {
                let html =`<!doctype html>
                <html lang="en">
                    <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="height=device-height, initial-scale=1.0, maximum-scale=1, user-scalable=0">
                        <meta name="description" content="share a session, not a password.....">
                        <title>Print PDF</title>
                        <style>
                            @page { size: 21cm 29.8cm; margin: 0; }
                            body { margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: lightslategrey; }
                            @media print { .page-container { height: 100%; width: 100%; } canvas { height: 100%; width: 100%; } }
                            canvas { # border:1px solid black; position: absolute; top: 0; }
                            .page-container { position: absolute; margin: 0; margin-top: 0px !important; font-size: 1px; line-height: 1; }
                            span { position: absolute; cursor: text; white-space: pre; transform-origin: left bottom; }
                        </style>
                    </head>
                    <body>
                        </${''}script>
                        <script>
                            var csl = console.log;
                            var jss = JSON.stringify;
                            var jsp = JSON.parse;
                            var sleep = async function(seconds){ return new Promise(resolve=>setTimeout(resolve,seconds*1000)); }
                            var localurl = window.location.href.replace('blob:', '').split('/').slice(0,-1).join('/');

                            import* as pdfjsLib from (localurl+'/pdf.js');

                            pdfjsLib.GlobalWorkerOptions.workerSrc = localurl+'/pdf.worker.js';
                            CanvasRenderingContext2D.prototype.strokeText = function () { };
                            CanvasRenderingContext2D.prototype.fillText = function () { };

                            refreshPDF('${fileurl}', JSON.parse('${JSON.stringify(settings)}')).then(()=>{
                                setTimeout(()=>{
                                    document.body.onafterprint = window.close;
                                    window.print();
                                    //setTimeout(()=>{
                                        //window.close();
                                    //},500);
                                },500)
                            });

                            

                            async function refreshPDF(fileurl, settings){
                                if(fileurl.indexOf('.') === 0) fileurl =  localurl+ fileurl.slice(1);
                                Array.from(document.querySelectorAll('.page-container')).forEach(child=>child.remove());

                                var pdfAsDataUri = await fetch('${url_script}?pdf='+encodeURIComponent(fileurl),{redirect:'follow'}).then(res=>res.json());
                                fileurl = convertDataURIToBinary('data:application/pdf;base64,'+pdfAsDataUri.result);

                                var loadingTask = pdfjsLib.getDocument(fileurl);
                                var pdf = await loadingTask.promise
                                for(var i = 1; i<= pdf.numPages; i++){
                                    console.log(i);
                                    let index = i;
                                    let page = await pdf.getPage(index)
                                    console.log(page);
                                    await handlePage(page, index, settings);
                                }
                                zoomOutMobile();
                            }

                            async function handlePage(page, index, settings) {
                                var viewport = page.getViewport({scale: 1.5});
                                var canvas = document.createElement( "canvas" );
                                canvas.style.display = "block";
                                var context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;

                                var renderContext = { canvasContext: context, viewport: viewport };
                                var renderTask = page.render(renderContext);
                                await renderTask.promise;

                                var pageContainer = document.createElement( "div" );
                                pageContainer.classList.add('page-container');
                                pageContainer.style.width = viewport.width + 'px';
                                pageContainer.style.height = viewport.height + 'px';
                                pageContainer.style.top = (index-1)*viewport.height + 'px';

                                pageContainer.appendChild( canvas );
                                document.body.appendChild( pageContainer );
                                
                                var textContent = await page.getTextContent({ normalizeWhitespace: true });
                                var items = textContent.items.map(function (textItem, i) {
                                    var tx = pdfjsLib.Util.transform( pdfjsLib.Util.transform(viewport.transform, textItem.transform),[1, 0, 0, -1, 0, 0] );
                                    var style = textContent.styles[textItem.fontName];
                                    // adjust for font ascent/descent
                                    var fontSize = Math.sqrt((tx[2] * tx[2]) + (tx[3] * tx[3]));
                                    if (style.ascent) { tx[5] -= fontSize * style.ascent; } else if (style.descent) { tx[5] -= fontSize * (1 + style.descent); } else { tx[5] -= fontSize / 2; }
                                    // adjust for rendered width
                                    if (textItem.width > 0) {
                                        context.font = tx[0] + 'px ' + style.fontFamily;
                                        var width = context.measureText(textItem.str).width;
                                        if (width > 0) { tx[0] = (textItem.width * viewport.scale) / width;}
                                    }

                                    var item = document.createElement('span');
                                    item.textContent = textItem.str;
                                    item.style.fontFamily = style.fontFamily;
                                    item.style.fontSize = fontSize + 'px';
                                    item.style.transform = 'scaleX(' + tx[0] + ')';
                                    item.style.left = tx[4] + 'px';
                                    item.style.top = tx[5] + 'px';

                                    pageContainer.appendChild(item);

                                    return item;
                                });
                                var destroynext = 0;
                                items.forEach(function (item, i) {
                                    if (destroynext){
                                        destroynext --;
                                        item.textContent = '';
                                        return;
                                    }
                                    var nextItemsSample = items.slice(i+1);

                                    Object.entries(settings).forEach(field=>{
                                        

                                        var right_border = item.offsetLeft+ item.offsetWidth;

                                        if (item.textContent.trim().length >= field[0].trim().length){
                                            if(item.textContent.indexOf(field[0]) < 0) return;
                                            item.textContent = item.textContent.replace(field[0],field[1].newText);
                                        }
                                        else{
                                            var working_field0 = field[0].replaceAll(' ', '');
                                            var j = 0;
                                            var plusNextText = item.textContent.trim() + nextItemsSample[j].textContent.trim();
                                            while(plusNextText.length < working_field0.length && nextItemsSample[j+1]){
                                                j++;
                                                plusNextText += nextItemsSample[j].textContent.trim();
                                            }
                                            console.log(plusNextText);
                                            if(plusNextText.trim().length < working_field0.trim().length || plusNextText.indexOf(working_field0) < 0 || plusNextText.indexOf(working_field0) >= item.textContent.trim().length) return;

                                            if(field[1].alignRight) right_border = nextItemsSample[j].offsetLeft+ nextItemsSample[j].offsetWidth;

                                            destroynext = j+1;
                                            item.textContent = plusNextText.replace(working_field0,field[1].newText);
                                        }
				                        if(field[1].alignRight) item.style.left = right_border - item.offsetWidth + 'px';
                                    })
                                });
                            }

                            function zoomOutMobile() {
                                var viewport = document.querySelector('meta[name="viewport"]');
                                if ( viewport ) { viewport.content = "initial-scale=0.1"; viewport.content = "width=700"; }
                            }


                            function convertDataURIToBinary(dataURI) {
                                var BASE64_MARKER = ';base64,';
                                var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
                                var base64 = dataURI.substring(base64Index);
                                var raw = window.atob(base64);
                                var rawLength = raw.length;
                                var array = new Uint8Array(new ArrayBuffer(rawLength));

                                for(var i = 0; i < rawLength; i++) {
                                    array[i] = raw.charCodeAt(i);
                                }
                                return array;
                            }
                        </${''}script>
                    </${''}body>
                </${''}html>`;
                const blob = new Blob([html], { type: "text/html" });
                const blobUrl = URL.createObjectURL(blob);
                window.open(blobUrl, "_blank");
            };


            function buildExplorer(){
                screen2.innerHTML = recursiveDiv(profile);

                Array.from(document.querySelectorAll('.main')).forEach(el=>{
                    if(el.dataset.reference?.length && currentDisplay.indexOf(el.id)<0 ) el.style.display='none';
                })
                Array.from(document.querySelectorAll('.clicktab')).forEach(el=>{
                    el.addEventListener('click', clicktabEL);
                    if(el.parentNode.querySelectorAll('.clicktab').length === 1) el.click();
                });
                Array.from(document.querySelectorAll('.cellinput')).forEach(el=>el.addEventListener('blur', cellinputEL));
                Array.from(document.querySelectorAll('.plusfield')).forEach(el=>{el.addEventListener('click', plusfieldEL)});
                Array.from(document.querySelectorAll('.appendrow')).forEach(el=>el.addEventListener('click', appendRowEL));
                Array.from(document.querySelectorAll('.addtask')).forEach(el=>el.addEventListener('click', addTaskEL));
                Array.from(document.querySelectorAll('.adddocument')).forEach(el=>el.addEventListener('click', adddocumentEL));
                Array.from(document.querySelectorAll('.deleteobj')).forEach(el=>el.addEventListener('click', deleteobjEL));
                Array.from(document.querySelectorAll('.uploadbutton')).forEach(el=>el.addEventListener('change', uploadEL));
                Array.from(document.querySelectorAll('.templatingbutton')).forEach(el=>el.addEventListener('click', templatingEL));

                filterEL();
            }
            function recursiveDiv(obj){
                Object.keys(data).forEach(key=>{if(obj?.ID.indexOf(pluralMapper[key])===0) data[key].push(obj);});
                id_dict[obj?.ID] = obj;
                var table_singular = obj.ID.indexOf('@') > 0 ? 'profile' : obj.ID.split('-')[0]
                var localHeaders = headers[table_singular];
                var tabs = [];
                var values = [];
                var style = BGMapper[obj.ID.split('-')[0]];

                
                var core = Object.entries(obj).sort((a,b)=>(localHeaders.indexOf(a[0]) - localHeaders.indexOf(b[0]))).map(e=>{
                    if((e[0] === 'tasks' || e[0] === 'documents') && !e[1].length) return '';
                    if(typeof e[1] === 'object'){
                        tabs.push(e[0]);
                        values.push(e[1]);
                    }
                    else if(obj.ID.indexOf('document') === 0 && e[0] === 'Lien' && !e[1].length) return `<div class="line">&nbsp;&nbsp;&nbsp;<label>Upload or Make</label><input type="file" class="cbutton uploadbutton" data-document="${obj.ID}" />&nbsp;&nbsp;&nbsp;<button class="cbutton templatingbutton" data-document="${obj.ID}">Templating</button></div>`;
                    else if(e[0] !== 'Reference' && e[0] !== 'Line' && e[0] !== 'ID') return `<div class="line">&nbsp;&nbsp;&nbsp;<label>${e[0]}</label>&nbsp;&nbsp;&nbsp;&nbsp;<span class="cellinput" data-cell="${e[0]}-${obj.ID}" contenteditable>${e[1]}</span>&nbsp;&nbsp;&nbsp;</div>`
                    return '';
                }).join('');

                return `<div class="main maindiv" id="${obj?.ID}" data-reference="${obj.Reference || ''}" style="${style}">
                    <div class="line topbuttons" style="justify-content:end;">
                        ${tabs.indexOf('documents') < 0 && obj.ID.indexOf('task') !== 0 && obj.ID.indexOf('document') !== 0 ? '<button title="+doc" class="cbutton pbutton adddocument" data-reference="'+obj.ID+'">+</button>' : ''}
                        ${tabs.indexOf('tasks') < 0 ? '<button title="+task" class="cbutton pbutton addtask" data-reference="'+obj.ID+'">+</button>' : ''}
                        ${Object.entries(obj).filter(e=>['Line', 'ID', 'Reference'].indexOf(e[0]) < 0 && e[1] && e[1].length > 0).length === 0 ? '<button title="delete line" class="cbutton pbutton deleteobj" data-reference="'+obj.ID+'">-</button>':''}
                    </div>
                    ${core}
                    <div class="line" data-reference="${obj.ID}"><button class="cbutton plusfield">+field</button></div>`+
                    (tabs.length ? `<div class="main" style="justify-content:space-between;">${tabs.sort().map(t=>'<label class="clicktab" data-filter="'+pluralMapper[t]+'" data-reference="'+obj.ID+'" style="'+BGMapper[pluralMapper[t]]+'">'+t+'</label>').join('')}</div>` : '' )+
                    values.map(e=>e.map(o=>recursiveDiv(o)).join('')).join('')+
                    tabs.sort().map(t=>`<div class="main" id="${pluralMapper[t]}-append-${obj.ID}" data-reference="${obj.ID}"><button class="cbutton appendrow">+${pluralMapper[t]}</button></div>`).join('')+
                `</div>`;
            }
            function filterEL(){
                var str = filtersearch.value.toLowerCase();
                Array.from(document.querySelectorAll('.maindiv')).forEach(el=>{
                    if(!el.dataset.reference?.length || currentDisplay.indexOf(el.id)>=0 ) el.style.display='flex';
                });
                if(str.length === 0) return;
                Array.from(document.querySelectorAll('.maindiv')).forEach(el=>{
                    var HTML = el.innerHTML.toLowerCase();
                    if (
                        el.style.display === 'flex' &&
                        HTML.indexOf('id="'+str) < 0 && 
                        HTML.indexOf('data-reference="'+str) < 0 && 
                        Array.from(el.querySelectorAll('span')).map(el=>el.textContent).join(' ').toLowerCase().indexOf(str) < 0
                    ) el.style.display='none';
                })
            }
            function plusfieldEL(e){
                var field = window.prompt('Field Name');
                if(!field) return;
                var reference = e.target.parentNode.dataset.reference;
                var table_singular = reference.split('-')[0];
                var table = singularMapper[table_singular];
                const qs = new URLSearchParams({operation: 'updaterange', table});
                fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify({row: 0, col: headers[table_singular].length-1, val: field})}); //-1 car colonne Line ajoute on the fly
                headers[table_singular].splice(-1, 0, field);
                Object.values(data[table]).forEach(o=>{o[field] = ''});
                e.target.parentNode.insertAdjacentHTML('beforebegin', `<div class="line">&nbsp;&nbsp;&nbsp;<label>${field}</label>&nbsp;&nbsp;&nbsp;&nbsp;<span class="cellinput" data-cell="${field}-${reference}" contenteditable></span>&nbsp;&nbsp;&nbsp;</div>`);
                document.querySelector(`.cellinput[data-cell="${field}-${reference}"]`).addEventListener('blur',cellinputEL);
            }
            function clicktabEL(e){
                var el = e.target;
                Array.from(document.querySelectorAll(`.clicktab[data-reference="${e.target.dataset.reference}"]`)).forEach(el=>{
                    el.classList.remove('selected')
                })
                e.target.classList.add('selected');
                var filter = e.target.dataset.filter;
                Array.from(document.querySelectorAll('.main')).forEach(el=>{
                    if(el.dataset.reference?.length && el.dataset.reference === e.target.dataset.reference && el.id.indexOf(filter) === 0){
                        el.style.display='flex';
                        currentDisplay.push(el.id);
                    }
                    else if(el.dataset.reference?.length && el.dataset.reference === e.target.dataset.reference){
                        el.style.display='none';
                        currentDisplay = currentDisplay.filter(id=>id !== el.id);
                    } 
                })
            }
            function cellinputEL(e){
                var newVal = e.target.innerHTML;
                var cellRef = e.target.dataset.cell.split('-');
                var table = singularMapper[cellRef[1].indexOf('@') > 0 ? 'profile' : cellRef[1]];
                var row = cellRef[1].indexOf('@') > 0 ? profile : id_dict[cellRef[1]+'-'+cellRef[2]];
                console.log(cellRef, newVal, row, table);
                row[cellRef[0]] = newVal;
                if(Object.entries(row).filter(e=>['Line', 'ID', 'Reference'].indexOf(e[0]) < 0 && e[1] && e[1].length > 0).length === 0) buildExplorer(); //display garbage button on container
                const qs = new URLSearchParams({operation: 'updaterange', table});
                fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify({row: row.Line, col: headers[pluralMapper[table]].indexOf(cellRef[0]), val: newVal})});
            }
            async function appendRowEL(e){
                var reference= e.target.parentNode.dataset.reference;
                var id = e.target.parentNode.id;
                var table_singular = id.split('-')[0]
                var ID = table_singular+'-'+ genRndStr(12);
                var table = singularMapper[table_singular];
                var row = {...headers[table_singular].reduce((acc,h)=>({[h]: '', ...acc}),{}), Reference: reference,ID};
                console.log(table, row, reference)
                const qs = new URLSearchParams({operation: 'appendrow', table});
                var res = await fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify([reference, ID])}).then(res=>res.json());
                row.Line = res.Line-1;
                data[table].push(row);
                id_dict[row.ID] = row;
                
                id_dict[reference][table] = id_dict[reference][table] || [];
                id_dict[reference][table].push(row);

                buildExplorer();
                document.querySelector(`.clicktab[data-filter="${table_singular}"][data-reference="${reference}"]`).click();
            }
            async function addTaskEL(e){
                var ID = e.target.dataset.reference;
                var task = {...headers.task.reduce((acc,h)=>({[h]: '', ...acc}),{}), Reference: ID, ID:'task-'+ genRndStr(12)};
                const qs = new URLSearchParams({operation: 'appendrow', table: 'tasks'});
                var res = await fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify(headers.task.map(h=>task[h] || ''))}).then(res=>res.json());
                task.Line = res.Line-1;
                data.tasks.push(task);
                id_dict[task.ID] = task;

                id_dict[ID].tasks = id_dict[ID].tasks || [];
                id_dict[ID].tasks.push(task);
                
                buildExplorer();
                document.querySelector(`.clicktab[data-filter="task"][data-reference="${ID}"]`).click();
            }
            async function adddocumentEL(e){
                var ID = e.target.dataset.reference;
                var doc= {...headers.document.reduce((acc,h)=>({[h]: '', ...acc}),{}), Reference: ID, ID:'document-'+ genRndStr(12)};
                const qs = new URLSearchParams({operation: 'appendrow', table: 'documents'});
                var res = await fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify(headers.document.map(h=>document[h] || ''))}).then(res=>res.json());
                doc.Line = res.Line-1;
                data.documents.push(doc);
                id_dict[doc.ID] = doc;

                id_dict[ID].documents = id_dict[ID].documents || [];
                id_dict[ID].documents.push(doc);
                
                buildExplorer();
                document.querySelector(`.clicktab[data-filter="document"][data-reference="${ID}"]`).click();
            }
            async function deleteobjEL(e){
                var ID = e.target.dataset.reference;
                var cellRef = ID.split('-');
                var table = singularMapper[cellRef[0].indexOf('@') > 0 ? 'profile' : cellRef[0]];
                const qs = new URLSearchParams({operation: 'updaterange', table});
                var res = await fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify({row: id_dict[ID].Line, col: headers[pluralMapper[table]].indexOf('ID'), val: ''})}).then(res=>res.json());
                var res2 = await fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify({row: id_dict[ID].Line, col: headers[pluralMapper[table]].indexOf('Reference'), val: ''})}).then(res=>res.json());
                data[table] === data[table].filter(r=>r.ID !== ID);
                if(id_dict[ID].Reference) id_dict[ID][table] = id_dict[ID][table].filter(r=>r.ID !== ID);
                delete id_dict[ID];

                buildExplorer();
                document.querySelector(`.clicktab[data-filter="${table_singular}"][data-reference="${reference}"]`).click();
            }
            function uploadEL(e){
                const file = e.target.files[0];
                const fr = new FileReader();
                fr.readAsArrayBuffer(file);
                fr.onload = async (f) => {
                    var qs = new URLSearchParams({operation: 'pushdocument', filename: file.name,mimeType: file.type});
                    var res = await fetch(`${url_script}?${qs}`, {method: "POST",body: JSON.stringify([...new Int8Array(f.target.result)]),}).then((res) => res.json());
                    var row = id_dict[e.target.dataset.document];
                    row.Lien = res.fileUrl;
                    var parent = e.target.parentElement;
                    console.log(e.target, parent)
                    parent.querySelector('label').innerHTML = 'Lien';
                    console.log(e.target, parent)
                    parent.querySelector('input').remove();
                    console.log(e.target, parent)
                    parent.innerHTML += `<span class="cellinput" data-cell="Lien-${row.ID}" contenteditable>${row.Lien}</span>`;
                    
                    qs = new URLSearchParams({operation: 'updaterange', table: 'documents'});
                    fetch(`${url_script}?${qs}`,{method:'POST', redirect:'follow', body: JSON.stringify({row: row.Line, col: headers.document.indexOf('Lien'), val: row.Lien})});
                };
            }
            
            closemd.addEventListener('click',(e)=>{
                modaldisplay.style.display = 'none';
            })
            function resolveEntityValue(map){   
                var entity = (map[0] === 'profile' ? profile : data[singularMapper[map[0]]].filter(e=>currentDisplay.includes(e.ID))[0]);
                if(!entity) entity = data[singularMapper[map[0]]].filter(e=>currentDisplay.includes(e.Reference))[0];
                if(!entity) entity = data[singularMapper[map[0]]][0];
                return entity && entity[map[1]];
            }
            function openModalScript(){
                modalscripting.style.display = 'flex';
                document.querySelector('.modal-background').style.display = 'block';
            }
            function openModalTemplate(){
                modaltemplate.style.display = 'flex';
                document.querySelector('.modal-background').style.display = 'block';
            }
            function closeModal(){
                Array.from(document.querySelectorAll('.modal')).forEach(el=>{
                    el.style.display = 'none';
                })
                document.querySelector('.modal-background').style.display = 'none';
            }
            function toObj(arr,headers){
                return headers.reduce((acc, h, i)=>({[h]: arr[i], ...acc}),{}); 
            }
            function clip(val, copy_indicator){
                copy_indicator.style.display = 'block';
                setTimeout(()=>{copy_indicator.style.display = 'none';}, 2000);
                navigator.clipboard.writeText(val);
            }
            function genRndStr(len){
                var chars = 'abcdefghijklmnopqrstuvwxyz1234567890';
                return new Array(len).fill(0).map(c=>chars[Math.floor(Math.random()*len)]).join('');
            }
        </script>
    </body>
</html>
